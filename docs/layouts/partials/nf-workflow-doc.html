
{{ $page_context := .Page }} <!-- not sure how this works, needed for the badges in the for loop... -->
{{ $commit_id := getenv "SCAMP_COMMIT" }}
{{ $viewURL := .Site.Params.viewURL }}
{{ $pagePath := replace .File.Path ".md" "" }}

<!-- show description -->

<p>{{ .Params.description | markdownify | safeHTML }}</p>

{{ partial "shortcodes/button.html" (dict
           "context" $page_context
           "href" (printf "%s/%s/%s" $viewURL $commit_id $pagePath)
           "target" "_blank"
           "style" "transparent"
           "icon" "fab fa-github"
           "content" "workflow") }}

<!-- show steps table -->

{{ if $steps := .Params.steps }}
	<h2 id="steps">{{ partial "shortcodes/icon.html" (dict "context" $page_context "icon" "tasks") }} Steps</h2>
	{{ range $step := $steps }}
		{{ $name := index $step "name" }}
		<h3 id="{{ anchorize $name }}">{{ markdownify $name }}</h3>
		<p>{{ index $step "description" | markdownify }}</p>
		{{ if $anchor := $step.anchor }}
			{{ partial "shortcodes/button.html" (dict
			           "context" $page_context
			           "href" (printf "%s/%s/%s/main.nf#L%d" $viewURL $commit_id $pagePath $anchor)
			           "target" "_blank"
			           "style" "transparent"
			           "icon" "fab fa-github"
			           "content" (printf "workflow:L%d" $anchor)) }}
		{{ end }}
		{{ if $modules := $step.modules }}
			{{ range $module := $modules}}
				{{ partial "shortcodes/button.html" (dict
				           "context" $page_context
				           "href" (ref $page_context (printf "/modules/%s" $module))
				           "target" "1"
				           "style" "transparent"
				           "icon" "cogs"
				           "content" $module) }}
			{{ end }}
		{{ end }}
	{{ end }}
{{ end }}

<!-- show dumped channel tags table -->

{{ if $channel_tags := index .Params "channel tags" }}
	<h2>{{ partial "shortcodes/icon.html" (dict "context" . "icon" "tree") }} Printable channels</h2>
	<p>These channels can be dumped to the output device using the `-dump-channels` Nextflow option.</p>
	<table class="channel-tags-table">
		<tr>
			<th>Tag</th>
			<th>Description</th>
		</tr>
		{{ range $channel_tag := $channel_tags }}
			{{ range $tag,$description := $channel_tag }}
				<tr>
					<td><code>{{ $tag }}</code></td>
					<td>{{ $description | markdownify }}</td>
				</tr>
			{{ end }}
		{{ end }}
	</table>
{{ end }}

<!-- show parameters table -->

{{ if $parameters := .Params.parameters_disabled }}
	<h2>{{ partial "shortcodes/icon.html" (dict "context" . "icon" "cubes") }} Workflow parameters</h2>
	<table class="parameters-table">
		<tr>
			<th>Channel key</th>
			<th>Description</th>
			<th>Type</th>
			<th>Provider</th>
		</tr>
		{{ range $info := sort $parameters "key" }}
			<tr>
				<td><code>{{ index $info "key" }}</code></td>
				<td>{{ index $info "description" | markdownify }}</td>
				<td><code>{{ index $info "type" }}</code></td>
				<td>
					{{ $args := dict "user"    (dict "colour" "orange" "icon" "user")
					                 "default" (dict "colour" "green" "icon" "dog")
					                 "process" (dict "colour" "blue" "icon" "cogs")}}

					{{ if $info.providers }}
						{{ range $provider := slice "user" "default" "process" }}
							{{ if $provider_value := index $info.providers $provider }}
								{{ $colour := index (index $args $provider) "colour" }}
								{{ $icon := index (index $args $provider) "icon" }}

								{{ $hover := $provider }}
								{{ if eq $provider "user" }}
									{{ $hover = printf "scamp-file parameter: %s" $provider_value }}
								{{ else if eq $provider "default" }}
									{{ $hover = printf "default value: %s" $provider_value }}
								{{ else if eq $provider "process" }}
									{{ $hover = printf "provided by upstream process: %s" $provider_value }}
								{{ end }}

								{{ $args := dict
									"context" $page_context
									"title" " "
									"style" $colour
									"content" (partial "shortcodes/icon.html" (dict "context" $page_context "icon" $icon))
									"hover" $hover }}

								{{ partial "shortcodes/badge.html" $args }}
							{{ end }}
						{{ end }}
					{{ end }}
				</td>
			</tr>
		{{ end }}
	</table>
{{ end }}

<!-- show outputs table -->

{{ if $output := .Params.output_disabled }}
	<h2>{{ partial "shortcodes/icon.html" (dict "context" $page_context "icon" "sign-out-alt") }} Emitted objects</h2>
	<table class="outputs-table">
		<tr>
			<th>Emission name</th>
			<th>Description</th>
			<th>Type</th>
		</tr>
		{{ range $info := $output }}
		<tr>
			<td><code>{{ index $info "name" }}</code></td>
			<td>{{ index $info "description" | markdownify }}</td>
			<td><code>{{ index $info "type" }}</code></td>
		</tr>
		{{ end }}
	</table>
{{ end }}
