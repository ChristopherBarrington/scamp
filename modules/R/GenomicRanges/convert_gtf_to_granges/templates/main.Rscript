#! /bin/env Rscript

# *************************************************************************************************
# given the path to gtf and fai files, this script:
# - creates a GRanges object
# - saves it as an rds file
# *************************************************************************************************

# -------------------------------------------------------------------------------------------------
# attach and record packages used in this Rscript
# -------------------------------------------------------------------------------------------------

library(dplyr)
library(gtools)
library(magrittr)
library(GenomeInfoDb)
library(rtracklayer)
library(scampr)

record_package_versions()

# -------------------------------------------------------------------------------------------------
# collect nextflow properties for the task
# -------------------------------------------------------------------------------------------------

list(genome = "$genome",
     gtf_file = "$gtf",
     fai_file = "$fai") |> assign_and_record_nextflow_properties()

# -------------------------------------------------------------------------------------------------
# start the task
# -------------------------------------------------------------------------------------------------

log_message('converting a gtf file to granges', level='main')

# -------------------------------------------------------------------------------------------------
# make a Seqinfo object for the genome
# -------------------------------------------------------------------------------------------------

log_message('making a Seqinfo object for the genome', level='section')

read.delim(file=fai_file, header=FALSE, sep='\t') |>
	select(seqnames=V1, seqlengths=V2) |>
	arrange(mixedorder(seqnames)) |>
	arrange(match(seqnames, mixedsort(seqnames))) |>
	as.list() |>
	append(list(genome=genome)) |>
	do.call(what=Seqinfo) -> seqinfo

# -------------------------------------------------------------------------------------------------
# import GTF file
# -------------------------------------------------------------------------------------------------

log_message('making a granges of the gene models', level='section')

import(con=gtf_file, format='GTF') -> granges

if(mcols(granges)\$gene_biotype |> is.null())
	mcols(granges)\$gene_biotype <- mcols(granges)\$gene_type

seqlevels(granges) <- seqlevels(seqinfo)
seqinfo(granges) <- seqinfo

# -------------------------------------------------------------------------------------------------
# write any output files
# -------------------------------------------------------------------------------------------------

log_message("writing output files", level='section')

saveRDS(object=granges, file='granges.rds')

log_message("script completed", level='main')
