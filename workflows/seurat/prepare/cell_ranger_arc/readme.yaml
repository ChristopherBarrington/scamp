name: Prepare Seurat from Cell Ranger ARC

description: |
  Using the filtered single nucleus expression and accessibility matrices, written by Cell Ranger ARC, a Seurat object is prepared that contains RNA and chromatin accessibility assays with little modification.

tags:
  - 10x
  - seurat
  - multiome

steps:
  - name: Make GRanges object
    description: A GRanges object is created for each genome in the project using the GTF file in the `index path`. This will be saved into the Seurat object's `misc` slot later in the workflow. 
    anchor: 42
    modules:
      - R/GenomicRanges/convert_gtf_to_granges

  - name: Read Cell Ranger ARC output into assays
    description: "Read the Cell Ranger ARC `filtered_feature_bc_matrix` and save the result, ready to create assay(s). Two RNA assays are created for each dataset: one using features indexed by accession and another by feature name. An additional chromatin accessibility assay is created, for which accession and name are the same since they are genomic intervals."
    anchor: 71
    modules:
      - R/Seurat/write_10x_counts_matrices
      - R/Seurat/make_assay
      - R/Signac/make_chromatin_assay

  - name: Create Seurat object
    description: Collect the miscellaneous data and assays and create a Seurat object, saved as an RDS file.
    anchor: 161
    modules:
      - R/Seurat/make_object

output:
  - name: result
    type: channel
    description: A channel of maps that are the same as the input parameters sets but now include a `seurat path` parameter.

parameters:
  - key: genome
    description: The name of the genome used for the dataset. This is used as the task's tag and in the `cellranger-arc mkref` configuration file.
    type: string
    providers:
      user: genome
  - key: index path
    description: Path to the index that against which the dataset was quantified, which provides the genes GTF file and genome FastA index. If not provided in the parameters, it should have been created by the `quantification/cell_ranger_arc` workflow.
    type: path
    providers:
      user: index path
  - key: unique id
    description: An identifier for the analysis and dataset that is used as the task's tag.
    type: string
    providers:
      user: unique id
      default: stage name and dataset name
  - key: quantification path
    description: Path to the Cell Ranger ARC `outs` directory under which `filtered_feature_bc_matrix` can be found. If not provided in the parameters, this should be provided by the `quantification/cell_ranger_arc` workflow.
    type: path
    providers:
      user: quantification path
      default: quantification/cell_ranger_arc/count
  - key: feature identifiers
    description: Whether to use `accession` or `name` as the RNA feature index. The non-selected identifier is saved into an `RNA_alt` assay in the object.
    type: string
    providers:
      user: feature identifiers
  - key: remove barcode suffixes
    description: (R) boolean as to whether the numeric suffixes of cell barcodes should be removed. These get messy with multiple integrations and could be replaced by the short dataset tag.
    type: string
  - key: dataset name
    description: A human-readable name for the dataset that will be used as the Seurat `Project`. If not provided in the parameters, the dataset key will be used.
    type: string
    providers:
      user: dataset name
      default: dataset key from parameters file
  - key: dataset id
    description: A filesystem-safe dataset name. {scamp} will try to convert the dataset name if not provided.
    type: string
    providers:
      user: dataset id
      default: parsed dataset name

channel tags:
  - ':gtf_files_to_convert_to_granges': A channel of paths to GTF files from unique indexes in the workflow's parameters.
  - ':granges_files': The created GTF GRanges object for each index.
  - ':barcoded_matrices_to_read': Parameters to read filtered expression matrices in both accession or name modes using.
  - ':barcoded_matrices': Paths to the created matrix objects that will be used to write assays.
  - ':rna_assays_branched': Parameters used to create RNA assays using either accessions or names.
  - ':rna_assays': Merge of accession- and name-indexed assays.
  - ':chromatin_assays_to_create': Parameters used to make a Signac chromatin accessibility assay.
  - ':chromatin_assays': Paths to the created chromatin accessibility assays.
  - ':objects_to_create': Parameters used to create Seurat objects.
  - ':objects': Paths to created Seurat objects.
  - ':final_results': Input parameters with `seurat path` key added.

authors:
  - "@ChristopherBarrington"
