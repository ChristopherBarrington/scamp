name: Quantify single nucleus multiome assays using Cell Ranger ARC

description: |
  Using `cellranger-arc` software, libraries for snRNA-seq and cell-matched snATAC-seq assays are quantified against an index, which can be optionally created.

tags:
  - 10x
  - quantification
  - multiome

steps:
  - name: Create missing indexes
    description: For datasets that do not have an `index path`, an index is created using the information in the `genome` stanza. The unique set of required indexes are created.
    anchor: 29
    modules:
      - cell_ranger_arc/mkref
  - name: Create project sample sheet
    description: Write a formatted configuration file that includes all libraries in this project which will be subset for libraries in a dataset.
    anchor: 66
    modules:
      - cell_ranger_arc/make_libraries_csv

  - name: Quantify assays
    description: Use the FastQ files to quantify RNA expression and chromatin accessibility in single cells.
    anchor: 91
    modules:
      - cell_ranger_arc/count

output:
  - name: result
    type: channel
    description: A channel of maps that are the same as the input parameter sets but now include `index path`, `quantification method` and `quantification path` keys.

parameters:
  - key: genome
    description: Name of the genome, used for the task's tag.
    type: string
    providers:
      user: genome
  - key: organism
    description: Name of the organism, for example "mus musculus".
    type: string
    providers:
      user: organism
  - key: assembly
    description: Name of the genome assembly, for example "mm10".
    type: string
    providers:
      user: assembly
  - key: non-nuclear contigs
    description: Collection of chromosomes in the FastA files that are not located in the nucleus, for example "chrM".
    type: strings
    providers:
      user: non-nuclear contigs
  - key: motifs
    description: File of transcription factor motifs in [JASPAR](https://jaspar.genereg.net/downloads/) format.
    type: file
    providers:
      user: motifs
  - key: fasta files
    description: Paths to FastA files that will be concatenated together into a single genome file.
    type: paths
    providers:
      user: fasta files
  - key: gtf files
    description: Paths to well-formatted GTF files describing gene models which will be concatenated together into a single GTF file.
    type: files
    providers:
      user: gtf files
  - key: fastq paths
    description: Directories containing FastQ files for this project that will match `(.*)_S[0-9]+_L[0-9]+_R1_001.fastq.gz`.
    type: paths
    providers:
      user: fastq paths
  - key: fastq_files_regex
    description: Regular expression used to parse the FastQ file name to get a sample name. Expects files to be named according to `bcl2fastq` standards.
    type: string
  - key: sample_names
    description: Names of all libraries in the project, taken from the `feature types` key in the {scamp} parameters file.
    type: strings
  - key: feature types
    description: A map of feature types and LIMS IDs.
    type: map
    providers:
      user: feature types
  - key: unique id
    description: Identifier used for the task's tag.
    type: string
    providers:
      user: unique id
      default: stage name and dataset name
  - key: dataset id
    description: Output directory name
    type: string
    providers:
      user: dataset id
      default: parsed dataset name
  - key: limsid
    description: Collection of LIMS IDs relevant to a dataset.
    type: strings
    providers:
      user: limsid
  - key: index path
    description: Path to the Cell Ranger ARC index. If missing, this will be added by the workflow using the genome information, as [described above](#create-missing-indexes).
    type: path
    providers:
      user: index path
      process: quantification/cell_ranger_arc/mkref

channel tags:
  - ':genome_indexes.missing': Datasets for which the `index path` is missing, indexes will be created for these.
  - ':genome_indexes.provided': Datasets for which the `index path` has been provided.
  - ':index_paths': The indexes that have been created or provided.
  - ':feature_type_params': A channel that collates the project-wide information required to make the Cell Ranger ARC sample sheet.
  - ':datasets_to_quantify': Parameter sets for datasets that will be quantified.
  - ':quantified_datasets': Parameter sets of datasets that were quantified.
  - ':final_results': Input parameters with the `index path` (if applicable), `libraries_csv`, `quantification method` and `quantification path` keys added.

authors:
  - "@ChristopherBarrington"
